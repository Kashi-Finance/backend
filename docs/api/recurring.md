# Recurring Transaction Endpoints

> **Scheduled transaction rules for automatic transaction generation**

## Table of Contents

1. [Endpoint Reference](#endpoint-reference)
2. [Recurring Transaction Schema](#recurring-transaction-schema)
3. [Frequency Rules](#frequency-rules)
4. [GET /recurring-transactions](#get-recurring-transactions)
5. [POST /recurring-transactions](#post-recurring-transactions)
6. [GET /recurring-transactions/{id}](#get-recurring-transactionsid)
7. [PATCH /recurring-transactions/{id}](#patch-recurring-transactionsid)
8. [DELETE /recurring-transactions/{id}](#delete-recurring-transactionsid)
9. [Integration Notes](#integration-notes)

---

## Endpoint Reference

| Method | Path | Description |
|--------|------|-------------|
| GET | `/recurring-transactions` | List all rules |
| POST | `/recurring-transactions` | Create new rule |
| GET | `/recurring-transactions/{id}` | Get rule details |
| PATCH | `/recurring-transactions/{id}` | Update rule |
| DELETE | `/recurring-transactions/{id}` | Delete rule (+ paired) |

**Related:** `POST /transactions/sync-recurring` - Generate pending transactions

---

## Recurring Transaction Schema

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "account_id": "uuid",
  "category_id": "uuid",
  "flow_type": "outcome",
  "amount": 1200.00,
  "description": "Monthly rent payment",
  "paired_recurring_transaction_id": null,
  "frequency": "monthly",
  "interval": 1,
  "by_weekday": null,
  "by_monthday": [1],
  "start_date": "2025-01-01",
  "next_run_date": "2025-12-01",
  "end_date": null,
  "is_active": true,
  "created_at": "...",
  "updated_at": "..."
}
```

---

## Frequency Rules

| Frequency | Description | Required Field |
|-----------|-------------|----------------|
| `daily` | Every N days | - |
| `weekly` | Every N weeks | `by_weekday` |
| `monthly` | Every N months | `by_monthday` |
| `yearly` | Every N years | - |

**❌ `once` is NOT allowed** (use budgets for one-time limits)

### by_weekday (weekly frequency)

Array of lowercase weekday names:
```json
["monday", "wednesday", "friday"]
```

### by_monthday (monthly frequency)

Array of day numbers (1-31):
```json
[1, 15]  // 1st and 15th of month
```

---

## GET /recurring-transactions

**Purpose:** List all recurring transaction rules.

**Response:**
```json
{
  "recurring_transactions": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "account_id": "uuid",
      "category_id": "uuid",
      "flow_type": "outcome",
      "amount": 1200.00,
      "description": "Monthly rent",
      "paired_recurring_transaction_id": null,
      "frequency": "monthly",
      "interval": 1,
      "by_weekday": null,
      "by_monthday": [1],
      "start_date": "2025-01-01",
      "next_run_date": "2025-12-01",
      "end_date": null,
      "is_active": true,
      "created_at": "...",
      "updated_at": "..."
    }
  ],
  "count": 1
}
```

**Status Codes:** 200, 401, 500

---

## POST /recurring-transactions

**Purpose:** Create a new recurring transaction rule.

**Request Body:**
```json
{
  "account_id": "uuid",
  "category_id": "uuid",
  "flow_type": "outcome",
  "amount": 1200.00,
  "description": "Monthly rent payment",
  "frequency": "monthly",
  "interval": 1,
  "by_monthday": [1],
  "start_date": "2025-12-01",
  "is_active": true
}
```

**Required Fields:**
- `account_id`, `category_id`, `flow_type`, `amount`, `description`
- `frequency`, `start_date`

**Conditional Fields:**
- `by_weekday` - Required for `frequency="weekly"`
- `by_monthday` - Required for `frequency="monthly"`

**Optional Fields:**
- `paired_recurring_transaction_id` (for recurring transfers)
- `interval` (default 1)
- `end_date` (nullable)
- `is_active` (default true)

**Validation:**
1. Weekly → `by_weekday` must be provided and non-empty
2. Monthly → `by_monthday` must be provided and non-empty
3. Weekday names must be valid lowercase
4. Day numbers must be 1-31
5. `interval` >= 1
6. `amount` > 0

**Response (201):**
```json
{
  "status": "CREATED",
  "recurring_transaction": { ... },
  "message": "Recurring transaction rule created successfully"
}
```

**Status Codes:** 201, 400, 401, 500

---

## GET /recurring-transactions/{id}

**Purpose:** Retrieve single rule details.

**Status Codes:** 200, 401, 404, 500

---

## PATCH /recurring-transactions/{id}

**Purpose:** Update a recurring transaction rule.

**Request Body (all optional):**
```json
{
  "description": "Updated description",
  "amount": 1500.00,
  "is_active": false,
  "end_date": "2026-12-31",
  "apply_retroactive_change": false
}
```

**Special Behaviors:**

### Changing start_date with apply_retroactive_change=true

- Deletes all past transactions generated by this rule
- ⚠️ Destructive operation, cannot be undone
- Returns `retroactive_deletes` count

### Reactivating (is_active: false → true)

- Recalculates `next_run_date` to next future occurrence
- Does NOT backfill missed occurrences

**Response:**
```json
{
  "status": "UPDATED",
  "recurring_transaction": { ... },
  "retroactive_deletes": 0,
  "message": "Recurring transaction rule updated successfully"
}
```

**Status Codes:** 200, 400, 401, 404, 500

---

## DELETE /recurring-transactions/{id}

**Purpose:** Delete a rule. If part of recurring transfer, deletes both.

**Behavior:**
1. Check if `paired_recurring_transaction_id` is set
2. If paired: Delete BOTH rules
3. If not paired: Delete single rule
4. Past generated transactions are NOT deleted

**Response (Paired):**
```json
{
  "status": "DELETED",
  "recurring_transaction_id": "rule-uuid-1",
  "paired_rule_deleted": true,
  "message": "Recurring transaction rule deleted successfully. Paired rule was also deleted."
}
```

**Response (Normal):**
```json
{
  "status": "DELETED",
  "recurring_transaction_id": "rule-uuid",
  "paired_rule_deleted": false,
  "message": "Recurring transaction rule deleted successfully."
}
```

**Status Codes:** 200, 401, 404, 500

---

## Integration Notes

### Transaction Generation

Rules generate transactions via `POST /transactions/sync-recurring`:

```
Rule (next_run_date <= today)
       │
       ▼
sync_recurring_transactions()
       │
       ├─► Create transaction(s)
       ├─► Update next_run_date
       └─► If paired → create paired transactions
```

### Recurring Transfer Creation

Use `POST /transfers/recurring` instead of this endpoint:
- Creates TWO paired rules
- Both linked via `paired_recurring_transaction_id`
- Uses system category `key='from_recurrent_transaction'`

See [transfers.md](./transfers.md) for recurring transfer details.

### Use Cases

- **Recurring bills:** Rent, utilities, subscriptions
- **Regular income:** Salary, freelance retainers
- **Automatic savings:** Paired transfer to savings account

### Difference from Budgets

| Feature | Recurring Transaction | Budget |
|---------|----------------------|--------|
| Purpose | Generate transactions | Track spending limits |
| `once` allowed | ❌ | ✓ |
| Creates transactions | ✓ (on sync) | ❌ |
| Tracks consumption | ❌ | ✓ |
